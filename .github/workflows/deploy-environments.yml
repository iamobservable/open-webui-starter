# Environment-Specific Deployment Pipeline Ð´Ð»Ñ ERNI-KI
# Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² development, staging, production Ñ environment-specific ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
# ÐÐ²Ñ‚Ð¾Ñ€: ÐÐ»ÑŒÑ‚ÑÐ¾Ð½ Ð¨ÑƒÐ»ÑŒÑ† (Tech Lead)
# Ð”Ð°Ñ‚Ð°: 2025-09-19

name: ðŸš€ Environment Deployment

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".github/workflows/ci.yml"
      - ".github/workflows/security.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment for deployment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production
      force_deploy:
        description: "Force deployment (skip some checks)"
        required: false
        default: false
        type: boolean

# Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
permissions:
  contents: read
  packages: write
  deployments: write
  actions: read

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# ÐžÑ‚Ð¼ÐµÐ½Ð° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð²
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.environment || 'auto' }}
  cancel-in-progress: true

jobs:
  # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
  determine-environment:
    name: ðŸŽ¯ Determine Target Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}

    steps:
      - name: ðŸ“‹ Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

          echo "ðŸŽ¯ Target environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d'=' -f2)"

  # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð´Ð»Ñ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
  validate-secrets:
    name: ðŸ” Validate Environment Secrets
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    if: needs.determine-environment.outputs.should_deploy == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Validate required config
        # pragma: allowlist secret
        run: |
          echo "Validating environment config for: ${{ needs.determine-environment.outputs.environment }}"

          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑƒÑ„Ñ„Ð¸ÐºÑ Ð´Ð»Ñ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          ENV_SUFFIX=""
          case "${{ needs.determine-environment.outputs.environment }}" in
            "development") ENV_SUFFIX="_DEV" ;;
            "staging") ENV_SUFFIX="_STAGING" ;;
            "production") ENV_SUFFIX="_PROD" ;;
          esac

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ¹ ÑÑ€ÐµÐ´Ñ‹
          required_env_keys=(
            "TUNNEL_TOKEN${ENV_SUFFIX}"
            "OPENAI_API_KEY${ENV_SUFFIX}"
          )

          missing_env_keys=()
          for env_key in "${required_env_keys[@]}"; do
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐºÐ»ÑŽÑ‡ Ð½Ðµ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ð¸ Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ placeholder
            env_value="${!env_key:-}"
            if [ -z "$env_value" ] || [[ "$env_value" == *"REPLACE_WITH_REAL"* ]]; then
              missing_env_keys+=("$env_key")
            else
              echo "âœ… $env_key: configured"
            fi
          done

          if [ ${#missing_env_keys[@]} -gt 0 ]; then
            echo "âŒ Missing or invalid environment keys:"
            printf '%s\n' "${missing_env_keys[@]}"

            if [ "${{ needs.determine-environment.outputs.environment }}" = "production" ]; then
              echo "ðŸ”´ CRITICAL: Production environment keys must be real values!"
              exit 1
            else
              echo "âš ï¸ WARNING: Some environment keys are missing, but continuing for non-production environment"
            fi
          else
            echo "âœ… All required environment keys are configured"
          fi
        env:
          TUNNEL_TOKEN_DEV: ${{ secrets.TUNNEL_TOKEN_DEV }}
          TUNNEL_TOKEN_STAGING: ${{ secrets.TUNNEL_TOKEN_STAGING }}
          TUNNEL_TOKEN_PROD: ${{ secrets.TUNNEL_TOKEN_PROD }}
          OPENAI_API_KEY_DEV: ${{ secrets.OPENAI_API_KEY_DEV }}
          OPENAI_API_KEY_STAGING: ${{ secrets.OPENAI_API_KEY_STAGING }}
          OPENAI_API_KEY_PROD: ${{ secrets.OPENAI_API_KEY_PROD }}
          CONTEXT7_API_KEY_DEV: ${{ secrets.CONTEXT7_API_KEY_DEV }}
          CONTEXT7_API_KEY_STAGING: ${{ secrets.CONTEXT7_API_KEY_STAGING }}
          CONTEXT7_API_KEY_PROD: ${{ secrets.CONTEXT7_API_KEY_PROD }}
          ANTHROPIC_API_KEY_DEV: ${{ secrets.ANTHROPIC_API_KEY_DEV }}
          ANTHROPIC_API_KEY_STAGING: ${{ secrets.ANTHROPIC_API_KEY_STAGING }}
          ANTHROPIC_API_KEY_PROD: ${{ secrets.ANTHROPIC_API_KEY_PROD }}
          GOOGLE_API_KEY_DEV: ${{ secrets.GOOGLE_API_KEY_DEV }}
          GOOGLE_API_KEY_STAGING: ${{ secrets.GOOGLE_API_KEY_STAGING }}
          GOOGLE_API_KEY_PROD: ${{ secrets.GOOGLE_API_KEY_PROD }}

  # Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ñ environment-specific ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, validate-secrets]
    environment: ${{ needs.determine-environment.outputs.environment }}
    if: needs.determine-environment.outputs.should_deploy == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=${{ needs.determine-environment.outputs.environment }}-latest

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./auth
          file: ./auth/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            ENVIRONMENT=${{ needs.determine-environment.outputs.environment }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          secrets: |
            tunnel_token=${{ secrets[format('TUNNEL_TOKEN_{0}', needs.determine-environment.outputs.environment == 'development' && 'DEV' || needs.determine-environment.outputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
            openai_key=${{ secrets[format('OPENAI_API_KEY_{0}', needs.determine-environment.outputs.environment == 'development' && 'DEV' || needs.determine-environment.outputs.environment == 'staging' && 'STAGING' || 'PROD')] }}

  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² Ñ†ÐµÐ»ÐµÐ²Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
  deploy:
    name: ðŸš€ Deploy to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, validate-secrets, build-and-deploy]
    environment: ${{ needs.determine-environment.outputs.environment }}
    if: needs.determine-environment.outputs.should_deploy == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Prepare environment configuration
        run: |
          echo "Preparing configuration for: ${{ needs.determine-environment.outputs.environment }}"

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ environment-specific ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
          mkdir -p .deploy-config

          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑƒÑ„Ñ„Ð¸ÐºÑ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          ENV_SUFFIX=""
          case "${{ needs.determine-environment.outputs.environment }}" in
            "development") ENV_SUFFIX="_DEV" ;;
            "staging") ENV_SUFFIX="_STAGING" ;;
            "production") ENV_SUFFIX="_PROD" ;;
          esac

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
          cat > .deploy-config/environment.env << EOF
          ENVIRONMENT=${{ needs.determine-environment.outputs.environment }}
          TUNNEL_TOKEN=${TUNNEL_TOKEN}
          OPENAI_API_KEY=${OPENAI_API_KEY}
          CONTEXT7_API_KEY=${CONTEXT7_API_KEY}
          ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
          GOOGLE_API_KEY=${GOOGLE_API_KEY}
          DEPLOY_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DEPLOY_SHA=${{ github.sha }}
          DEPLOY_REF=${{ github.ref }}
          EOF

          echo "âœ… Environment configuration prepared"
        env:
          TUNNEL_TOKEN: ${{ secrets[format('TUNNEL_TOKEN_{0}', needs.determine-environment.outputs.environment == 'development' && 'DEV' || needs.determine-environment.outputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          OPENAI_API_KEY: ${{ secrets[format('OPENAI_API_KEY_{0}', needs.determine-environment.outputs.environment == 'development' && 'DEV' || needs.determine-environment.outputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          CONTEXT7_API_KEY: ${{ secrets[format('CONTEXT7_API_KEY_{0}', needs.determine-environment.outputs.environment == 'development' && 'DEV' || needs.determine-environment.outputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          ANTHROPIC_API_KEY: ${{ secrets[format('ANTHROPIC_API_KEY_{0}', needs.determine-environment.outputs.environment == 'development' && 'DEV' || needs.determine-environment.outputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          GOOGLE_API_KEY: ${{ secrets[format('GOOGLE_API_KEY_{0}', needs.determine-environment.outputs.environment == 'development' && 'DEV' || needs.determine-environment.outputs.environment == 'staging' && 'STAGING' || 'PROD')] }}

      - name: ðŸŽ¯ Deploy to ${{ needs.determine-environment.outputs.environment }}
        run: |
          echo "ðŸš€ Deploying to ${{ needs.determine-environment.outputs.environment }} environment"
          echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.environment }}-latest"
          echo "ðŸ”§ Configuration: .deploy-config/environment.env"

          # Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ñ‡ÐµÑ€ÐµÐ· kubectl, docker-compose, etc.)
          echo "âœ… Deployment completed successfully"

      - name: ðŸ“Š Post-deployment verification
        run: |
          echo "ðŸ” Verifying deployment in ${{ needs.determine-environment.outputs.environment }}"

          # Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
          # ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, health checks, smoke tests, etc.

          echo "âœ… Deployment verification completed"

  # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ñ… Ð´ÐµÐ¿Ð»Ð¾Ñ
  notify:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy]
    if: always() && needs.determine-environment.outputs.should_deploy == 'true'

    steps:
      - name: ðŸ“¢ Send deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… Deployment to ${{ needs.determine-environment.outputs.environment }} completed successfully"
            echo "ðŸ”— Environment: ${{ needs.determine-environment.outputs.environment }}"
            echo "ðŸ“¦ SHA: ${{ github.sha }}"
            echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          else
            echo "âŒ Deployment to ${{ needs.determine-environment.outputs.environment }} failed"
            echo "ðŸ” Check the logs for details"
          fi
