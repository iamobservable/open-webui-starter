# Release Pipeline Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° erni-ki
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€ÐµÐ»Ð¸Ð·Ñ‹ Ñ semantic versioning

name: ðŸš€ Release

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".github/workflows/ci.yml"
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

# Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð¾Ð²
permissions:
  contents: write
  packages: write
  pull-requests: write
  issues: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð°
  version:
    name: ðŸ“‹ Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      changelog: ${{ steps.version.outputs.changelog }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ“¦ Install semantic-release
        run: |
          npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github

      - name: ðŸ·ï¸ Generate version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ñ€ÐµÐ»Ð¸Ð·
            CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            CURRENT_VERSION=${CURRENT_VERSION#v}

            case "${{ github.event.inputs.release_type }}" in
              "major")
                NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print ($1+1)".0.0"}')
                ;;
              "minor")
                NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print $1"."($2+1)".0"}')
                ;;
              "patch")
                NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print $1"."$2"."($3+1)}')
                ;;
            esac

            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "changelog=Manual release: ${{ github.event.inputs.release_type }} version bump" >> $GITHUB_OUTPUT
          else
            # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€ÐµÐ»Ð¸Ð· Ñ‡ÐµÑ€ÐµÐ· semantic-release
            npx semantic-release --dry-run --no-ci > release-output.txt 2>&1 || true

            if grep -q "The next release version is" release-output.txt; then
              VERSION=$(grep "The next release version is" release-output.txt | sed 's/.*The next release version is //')
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "tag=v$VERSION" >> $GITHUB_OUTPUT
              echo "changelog=Automated release based on conventional commits" >> $GITHUB_OUTPUT
            else
              echo "version=" >> $GITHUB_OUTPUT
              echo "tag=" >> $GITHUB_OUTPUT
              echo "changelog=" >> $GITHUB_OUTPUT
            fi
          fi

  # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ñ€ÐµÐ»Ð¸Ð·Ð¾Ð¼
  pre-release:
    name: ðŸ§ª Pre-release Tests
    runs-on: ubuntu-latest
    needs: [version]
    if: needs.version.outputs.version != ''

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.4"

      - name: ðŸ§ª Run comprehensive tests
        working-directory: ./auth
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out

      - name: ðŸ”’ Security scan
        run: |
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
          gosec ./auth/...

  # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð°
  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [version, pre-release]
    if: needs.version.outputs.version != ''

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ñ Ñ‚ÐµÐ³Ð°Ð¼Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð°
      - name: ðŸ—ï¸ Build and push release images
        uses: docker/build-push-action@v5
        with:
          context: ./auth
          file: ./auth/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth:${{ needs.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth:latest
          labels: |
            org.opencontainers.image.title=erni-ki-auth
            org.opencontainers.image.description=JWT Authentication service for erni-ki
            org.opencontainers.image.version=${{ needs.version.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ GitHub Ñ€ÐµÐ»Ð¸Ð·Ð°
      - name: ðŸ“‹ Generate changelog
        id: changelog
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changelog=${{ needs.version.outputs.changelog }}" >> $GITHUB_OUTPUT
          else
            # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ changelog Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
            if [ -n "$PREVIOUS_TAG" ]; then
              CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
            else
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
            fi

            # Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð»Ñ GitHub Actions
            CHANGELOG="${CHANGELOG//'%'/'%25'}"
            CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
            CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"

            echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ·ï¸ Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ needs.version.outputs.tag }} -m "Release ${{ needs.version.outputs.version }}"
          git push origin ${{ needs.version.outputs.tag }}

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: Release ${{ needs.version.outputs.version }}
          body: |
            ## ðŸš€ Release ${{ needs.version.outputs.version }}

            ### ðŸ“‹ Changes
            ${{ steps.changelog.outputs.changelog }}

            ### ðŸ³ Docker Images
            - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth:${{ needs.version.outputs.version }}`
            - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth:latest`

            ### ðŸ“Š Metrics
            - Build time: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}

            ### ðŸ”— Links
            - [Docker Image](${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth)
            - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          draft: false
          prerelease: false

  # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ñ€ÐµÐ»Ð¸Ð·Ðµ
  notify:
    name: ðŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [version, release]
    if: always() && needs.version.outputs.version != ''

    steps:
      - name: ðŸ“Š Create release summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.release.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth:${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
