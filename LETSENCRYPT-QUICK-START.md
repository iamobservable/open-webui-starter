# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: Let's Encrypt SSL –¥–ª—è ERNI-KI

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 5-8 –º–∏–Ω—É—Ç  
**–ú–µ—Ç–æ–¥:** DNS-01 Challenge —á–µ—Ä–µ–∑ Cloudflare API  
**–î–æ–º–µ–Ω—ã:** ki.erni-gruppe.ch + www.ki.erni-gruppe.ch

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ DNS-01 –º–µ—Ç–æ–¥–∞

- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: Cloudflare Proxy –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º (WAF + DDoS –∑–∞—â–∏—Ç–∞)
- ‚úÖ **–ë—ã—Å—Ç—Ä–æ**: 5-8 –º–∏–Ω—É—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 60 –¥–Ω–µ–π
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ**: –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Backrest

---

## üìã –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç–µ Cloudflare API Token

### 1.1 –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–∫–µ–Ω

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://dash.cloudflare.com/profile/api-tokens
2. –ù–∞–∂–º–∏—Ç–µ: **Create Token**
3. –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω: **Edit zone DNS**
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∞:
   - **Zone**: DNS - Edit
   - **Zone Resources**: Include - Specific zone - **erni-gruppe.ch**
5. –ù–∞–∂–º–∏—Ç–µ: **Continue to summary** ‚Üí **Create Token**
6. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω** (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!)

### 1.2 –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –ó–∞–º–µ–Ω–∏—Ç–µ YOUR_TOKEN –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω
curl -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:** `"success": true`

---

## üîß –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏

```bash
# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /home/konstantin/Documents/augment-projects/erni-ki

# –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x scripts/infrastructure/security/setup-letsencrypt-dns01-production.sh

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç
./scripts/infrastructure/security/setup-letsencrypt-dns01-production.sh
```

---

## üîë –®–∞–≥ 3: –í—Å—Ç–∞–≤—å—Ç–µ API Token

–°–∫—Ä–∏–ø—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç Cloudflare API Token:

```
–í—Å—Ç–∞–≤—å—Ç–µ Cloudflare API Token (–≤–≤–æ–¥ —Å–∫—Ä—ã—Ç):
```

–í—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∏ –Ω–∞–∂–º–∏—Ç–µ **Enter**.

---

## ‚è±Ô∏è –®–∞–≥ 4: –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç:

1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (30 —Å–µ–∫)
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ API Token (10 —Å–µ–∫)
3. ‚úÖ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Backrest (30 —Å–µ–∫)
4. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ acme.sh (1 –º–∏–Ω)
5. ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –æ—Ç Let's Encrypt (2-3 –º–∏–Ω)
6. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤ nginx (30 —Å–µ–∫)
7. ‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx –∏ Cloudflare Tunnel (1 –º–∏–Ω)
8. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (30 —Å–µ–∫)
9. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS –¥–æ—Å—Ç—É–ø–∞ (30 —Å–µ–∫)
10. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ ERNI-KI (30 —Å–µ–∫)

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 5-8 –º–∏–Ω—É—Ç

---

## ‚úÖ –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### 5.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS

```bash
# –û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω
curl -I https://ki.erni-gruppe.ch

# WWW –¥–æ–º–µ–Ω
curl -I https://www.ki.erni-gruppe.ch
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `HTTP/2 200` –±–µ–∑ SSL –æ—à–∏–±–æ–∫

### 5.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

```bash
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ
openssl x509 -in conf/nginx/ssl/nginx-fullchain.crt -noout -text | grep -A 2 "Subject Alternative Name"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
X509v3 Subject Alternative Name:
    DNS:ki.erni-gruppe.ch, DNS:www.ki.erni-gruppe.ch
```

### 5.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose ps
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ 14+ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ `healthy`

### 5.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://ki.erni-gruppe.ch
2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∑–∞–º–æ–∫ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - **–ò–∑–¥–∞—Ç–µ–ª—å**: Let's Encrypt
   - **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è**: 90 –¥–Ω–µ–π
   - **–î–æ–º–µ–Ω—ã**: ki.erni-gruppe.ch, www.ki.erni-gruppe.ch

---

## üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ **60 –¥–Ω–µ–π** —á–µ—Ä–µ–∑ acme.sh cron
job.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ cron job
crontab -l | grep acme

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
openssl x509 -in conf/nginx/ssl/nginx-fullchain.crt -noout -dates

# –õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
tail -f logs/ssl-renewal-*.log
```

### –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)

```bash
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
~/.acme.sh/acme.sh --renew -d ki.erni-gruppe.ch --force

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose restart nginx cloudflared
```

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: API Token –Ω–µ–≤–∞–ª–∏–¥–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ Cloudflare Dashboard
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ "Edit zone DNS"
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞

### –ü—Ä–æ–±–ª–µ–º–∞: DNS Challenge –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –∑–∞–ø–∏—Å–∏
dig _acme-challenge.ki.erni-gruppe.ch TXT +short

# –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã –¥–ª—è DNS —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
```

### –ü—Ä–æ–±–ª–µ–º–∞: HTTPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Cloudflare SSL Mode (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Full (strict))
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Cloudflare Tunnel
docker compose restart cloudflared

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker compose logs cloudflared --tail 50
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:
[docs/letsencrypt-ssl-setup-guide.md](docs/letsencrypt-ssl-setup-guide.md)

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- ‚úÖ –î–æ–º–µ–Ω ki.erni-gruppe.ch –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
- ‚úÖ –î–æ–º–µ–Ω www.ki.erni-gruppe.ch –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
- ‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç Let's Encrypt (R3)
- ‚úÖ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 90 –¥–Ω–µ–π
- ‚úÖ –í—Å–µ 14+ —Å–µ—Ä–≤–∏—Å–æ–≤ ERNI-KI –≤ —Å—Ç–∞—Ç—É—Å–µ healthy
- ‚úÖ Cloudflare Proxy –∞–∫—Ç–∏–≤–µ–Ω
- ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- ‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞

---

**–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å? –í—ã–ø–æ–ª–Ω–∏—Ç–µ –®–∞–≥ 1!** üöÄ
