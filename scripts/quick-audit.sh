#!/bin/bash
# –ë—ã—Å—Ç—Ä—ã–π –∞—É–¥–∏—Ç —Å–∏—Å—Ç–µ–º—ã ERNI-KI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞
# –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞

set -euo pipefail

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á–µ—Ç–∞
AUDIT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
AUDIT_REPORT_FILE="comprehensive-audit-report-$(date +%Y%m%d_%H%M%S).md"

# –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏—Å—Ç–µ–º–µ
collect_system_info() {
    log "–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏—Å—Ç–µ–º–µ..."

    HOSTNAME=$(hostname)
    USER=$(whoami)
    DOCKER_VERSION=$(docker --version 2>/dev/null || echo "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    COMPOSE_VERSION=$(docker-compose --version 2>/dev/null || docker compose version 2>/dev/null || echo "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

    # –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 | cut -d'.' -f1 2>/dev/null || echo "N/A")
    MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}' 2>/dev/null || echo "N/A")
    DISK_USAGE=$(df -h . | awk 'NR==2 {print $5}' 2>/dev/null || echo "N/A")

    success "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ —Å–æ–±—Ä–∞–Ω–∞"
}

# –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
audit_security() {
    log "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."

    SECURITY_ISSUES=()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π –≤ production —Ñ–∞–π–ª–∞—Ö
    if grep -r "CHANGE_BEFORE_GOING_LIVE\|password123\|admin123" env/ --exclude="*.example" 2>/dev/null; then
        SECURITY_ISSUES+=("CRITICAL|–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏|–ù–∞–π–¥–µ–Ω—ã –Ω–µ–∑–∞–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –≤ production —Ñ–∞–π–ª–∞—Ö|–ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ")
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ .env —Ñ–∞–π–ª–∞–º
    if find env/ -name "*.env" -not -name "*.example" -not -perm 600 2>/dev/null | grep -q .; then
        SECURITY_ISSUES+=("HIGH|–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞|–§–∞–π–ª—ã —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –∏–º–µ—é—Ç —Å–ª–∏—à–∫–æ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–∞–≤–∞|–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∞ 600 –¥–ª—è –≤—Å–µ—Ö .env —Ñ–∞–π–ª–æ–≤")
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker socket
    if grep -q "/var/run/docker.sock" compose.yml 2>/dev/null; then
        SECURITY_ISSUES+=("MEDIUM|Docker socket –¥–æ—Å—Ç—É–ø|–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ Docker socket|–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º —Å–µ—Ä–≤–∏—Å–∞–º")
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL/TLS
    if ! grep -q "ssl\|tls\|https" conf/nginx/ 2>/dev/null; then
        SECURITY_ISSUES+=("HIGH|–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç SSL/TLS|–í–µ–±-—Ç—Ä–∞—Ñ–∏–∫ –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω|–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL/TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã")
    fi

    success "–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω (–Ω–∞–π–¥–µ–Ω–æ ${#SECURITY_ISSUES[@]} –ø—Ä–æ–±–ª–µ–º)"
}

# –ê—É–¥–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
audit_performance() {
    log "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."

    PERFORMANCE_ISSUES=()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
    if [ "$CPU_USAGE" != "N/A" ] && [ "$CPU_USAGE" -gt 80 ] 2>/dev/null; then
        PERFORMANCE_ISSUES+=("MEDIUM|–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ CPU|CPU –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ ${CPU_USAGE}%|–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã")
    fi

    if [ "$MEMORY_USAGE" != "N/A" ] && [ "${MEMORY_USAGE%.*}" -gt 85 ] 2>/dev/null; then
        PERFORMANCE_ISSUES+=("MEDIUM|–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏|–û–ó–£ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ ${MEMORY_USAGE}%|–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –û–ó–£")
    fi

    if [ "$DISK_USAGE" != "N/A" ] && [ "${DISK_USAGE%\%}" -gt 85 ] 2>/dev/null; then
        PERFORMANCE_ISSUES+=("HIGH|–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞|–î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${DISK_USAGE}|–û—á–∏—Å—Ç–∏—Ç–µ –¥–∏—Å–∫ –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –æ–±—ä–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞")
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–µ—Å—É—Ä—Å–æ–≤
    if ! grep -q "mem_limit\|cpus\|memory" compose.yml 2>/dev/null; then
        PERFORMANCE_ISSUES+=("MEDIUM|–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤|–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã|–ù–∞—Å—Ç—Ä–æ–π—Ç–µ mem_limit –∏ cpus –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤")
    fi

    success "–ê—É–¥–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω (–Ω–∞–π–¥–µ–Ω–æ ${#PERFORMANCE_ISSUES[@]} –ø—Ä–æ–±–ª–µ–º)"
}

# –ê—É–¥–∏—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
audit_reliability() {
    log "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏—Ç–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏..."

    RELIABILITY_ISSUES=()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ health checks
    SERVICES_WITHOUT_HEALTHCHECK=()
    while IFS= read -r service; do
        if ! grep -A 10 "^  $service:" compose.yml | grep -q "healthcheck:" 2>/dev/null; then
            SERVICES_WITHOUT_HEALTHCHECK+=("$service")
        fi
    done < <(grep -E "^  [a-zA-Z].*:" compose.yml | sed 's/://g' | awk '{print $1}' 2>/dev/null || true)

    if [ ${#SERVICES_WITHOUT_HEALTHCHECK[@]} -gt 0 ]; then
        RELIABILITY_ISSUES+=("MEDIUM|–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç health checks|–°–µ—Ä–≤–∏—Å—ã ${SERVICES_WITHOUT_HEALTHCHECK[*]} –Ω–µ –∏–º–µ—é—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–¥–æ—Ä–æ–≤—å—è|–î–æ–±–∞–≤—å—Ç–µ healthcheck –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤")
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ restart policies
    if ! grep -q "restart:" compose.yml 2>/dev/null; then
        RELIABILITY_ISSUES+=("MEDIUM|–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç restart policies|–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏|–î–æ–±–∞–≤—å—Ç–µ restart: unless-stopped –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤")
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    if [ ! -d ".config-backup" ] || [ ! "$(ls -A .config-backup 2>/dev/null)" ]; then
        RELIABILITY_ISSUES+=("HIGH|–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ|Backrest –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö|–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è")
    fi

    success "–ê—É–¥–∏—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω (–Ω–∞–π–¥–µ–Ω–æ ${#RELIABILITY_ISSUES[@]} –ø—Ä–æ–±–ª–µ–º)"
}

# –ê—É–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
audit_configuration() {
    log "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

    CONFIG_ISSUES=()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Docker Compose
    COMPOSE_VERSION_NUM=$(grep "version:" compose.yml | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'" 2>/dev/null || echo "")
    if [ -z "$COMPOSE_VERSION_NUM" ]; then
        CONFIG_ISSUES+=("LOW|–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–µ—Ä—Å–∏—è Compose|–í–µ—Ä—Å–∏—è Docker Compose —Ñ–∞–π–ª–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞|–î–æ–±–∞–≤—å—Ç–µ version: '3.8' –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞")
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ example —Ñ–∞–π–ª–æ–≤
    for env_file in env/*.env; do
        if [ -f "$env_file" ]; then
            example_file="${env_file}.example"
            if [ ! -f "$example_file" ]; then
                CONFIG_ISSUES+=("LOW|–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç example —Ñ–∞–π–ª|–ù–µ—Ç $example_file|–°–æ–∑–¥–∞–π—Ç–µ example —Ñ–∞–π–ª —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
            fi
        fi
    done 2>/dev/null || true

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ bind mounts
    if grep -E "^\s*-\s*\./.*:" compose.yml | grep -v ":ro" 2>/dev/null; then
        CONFIG_ISSUES+=("MEDIUM|–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ bind mounts|Bind mounts –±–µ–∑ :ro –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏|–î–æ–±–∞–≤—å—Ç–µ :ro –¥–ª—è read-only bind mounts –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ")
    fi

    success "–ê—É–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω (–Ω–∞–π–¥–µ–Ω–æ ${#CONFIG_ISSUES[@]} –ø—Ä–æ–±–ª–µ–º)"
}

# –ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ–±–ª–µ–º –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
count_issues_by_severity() {
    CRITICAL_COUNT=0
    HIGH_COUNT=0
    MEDIUM_COUNT=0
    LOW_COUNT=0

    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –º–∞—Å—Å–∏–≤—ã –ø—Ä–æ–±–ª–µ–º
    ALL_ISSUES=()
    ALL_ISSUES+=("${SECURITY_ISSUES[@]}")
    ALL_ISSUES+=("${PERFORMANCE_ISSUES[@]}")
    ALL_ISSUES+=("${RELIABILITY_ISSUES[@]}")
    ALL_ISSUES+=("${CONFIG_ISSUES[@]}")

    for issue in "${ALL_ISSUES[@]}"; do
        severity=$(echo "$issue" | cut -d'|' -f1)
        case $severity in
            "CRITICAL") ((CRITICAL_COUNT++)) ;;
            "HIGH") ((HIGH_COUNT++)) ;;
            "MEDIUM") ((MEDIUM_COUNT++)) ;;
            "LOW") ((LOW_COUNT++)) ;;
        esac
    done
}

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
generate_report() {
    log "–°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞..."

    cat > "$AUDIT_REPORT_FILE" << EOF
# üîç –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ–¥–∞–∫—à–Ω –∞—É–¥–∏—Ç ERNI-KI

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞**: $AUDIT_DATE
**–°–∏—Å—Ç–µ–º–∞**: $HOSTNAME
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: $USER
**–í–µ—Ä—Å–∏—è Docker**: $DOCKER_VERSION
**–í–µ—Ä—Å–∏—è Docker Compose**: $COMPOSE_VERSION

## üìä –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ | –í—ã—Å–æ–∫–∏–µ | –°—Ä–µ–¥–Ω–∏–µ | –ù–∏–∑–∫–∏–µ | –í—Å–µ–≥–æ |
|-----------|-------------|---------|---------|--------|-------|
| üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | $(echo "${SECURITY_ISSUES[@]}" | grep -o "CRITICAL" | wc -l) | $(echo "${SECURITY_ISSUES[@]}" | grep -o "HIGH" | wc -l) | $(echo "${SECURITY_ISSUES[@]}" | grep -o "MEDIUM" | wc -l) | $(echo "${SECURITY_ISSUES[@]}" | grep -o "LOW" | wc -l) | ${#SECURITY_ISSUES[@]} |
| ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | $(echo "${PERFORMANCE_ISSUES[@]}" | grep -o "CRITICAL" | wc -l) | $(echo "${PERFORMANCE_ISSUES[@]}" | grep -o "HIGH" | wc -l) | $(echo "${PERFORMANCE_ISSUES[@]}" | grep -o "MEDIUM" | wc -l) | $(echo "${PERFORMANCE_ISSUES[@]}" | grep -o "LOW" | wc -l) | ${#PERFORMANCE_ISSUES[@]} |
| üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | $(echo "${RELIABILITY_ISSUES[@]}" | grep -o "CRITICAL" | wc -l) | $(echo "${RELIABILITY_ISSUES[@]}" | grep -o "HIGH" | wc -l) | $(echo "${RELIABILITY_ISSUES[@]}" | grep -o "MEDIUM" | wc -l) | $(echo "${RELIABILITY_ISSUES[@]}" | grep -o "LOW" | wc -l) | ${#RELIABILITY_ISSUES[@]} |
| ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | $(echo "${CONFIG_ISSUES[@]}" | grep -o "CRITICAL" | wc -l) | $(echo "${CONFIG_ISSUES[@]}" | grep -o "HIGH" | wc -l) | $(echo "${CONFIG_ISSUES[@]}" | grep -o "MEDIUM" | wc -l) | $(echo "${CONFIG_ISSUES[@]}" | grep -o "LOW" | wc -l) | ${#CONFIG_ISSUES[@]} |
| **–ò–¢–û–ì–û** | **$CRITICAL_COUNT** | **$HIGH_COUNT** | **$MEDIUM_COUNT** | **$LOW_COUNT** | **$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))** |

## üéØ –û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω—É

EOF

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—â–µ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    if [ $CRITICAL_COUNT -eq 0 ] && [ $HIGH_COUNT -eq 0 ]; then
        echo "‚úÖ **–ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ù–£** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç" >> "$AUDIT_REPORT_FILE"
    elif [ $CRITICAL_COUNT -eq 0 ] && [ $HIGH_COUNT -le 2 ]; then
        echo "‚ö†Ô∏è **–£–°–õ–û–í–ù–û –ì–û–¢–û–í** - –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –≤—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã" >> "$AUDIT_REPORT_FILE"
    else
        echo "‚ùå **–ù–ï –ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ù–£** - –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º" >> "$AUDIT_REPORT_FILE"
    fi

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
    add_detailed_sections

    success "–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $AUDIT_REPORT_FILE"
}

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ –æ—Ç—á–µ—Ç
add_detailed_sections() {
    cat >> "$AUDIT_REPORT_FILE" << 'EOF'

## üìà –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

EOF

    echo "- **CPU**: ${CPU_USAGE}% –∑–∞–≥—Ä—É–∂–µ–Ω" >> "$AUDIT_REPORT_FILE"
    echo "- **–ü–∞–º—è—Ç—å**: ${MEMORY_USAGE}% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ" >> "$AUDIT_REPORT_FILE"
    echo "- **–î–∏—Å–∫**: ${DISK_USAGE} –∑–∞–ø–æ–ª–Ω–µ–Ω" >> "$AUDIT_REPORT_FILE"
    echo "" >> "$AUDIT_REPORT_FILE"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    add_issues_section "üîí –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" "${SECURITY_ISSUES[@]}"
    add_issues_section "‚ö° –ê—É–¥–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏" "${PERFORMANCE_ISSUES[@]}"
    add_issues_section "üõ°Ô∏è –ê—É–¥–∏—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏" "${RELIABILITY_ISSUES[@]}"
    add_issues_section "‚öôÔ∏è –ê—É–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏" "${CONFIG_ISSUES[@]}"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ –ø–ª–∞–Ω–∞ –¥–µ–π—Å—Ç–≤–∏–π
    cat >> "$AUDIT_REPORT_FILE" << 'EOF'

## üí° –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- –ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL/TLS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤
- –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### üü† –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –î–æ–±–∞–≤—å—Ç–µ health checks –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ Docker socket

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- –û–±–Ω–æ–≤–∏—Ç–µ –≤–µ—Ä—Å–∏—é Docker Compose —Ñ–∞–π–ª–∞
- –°–æ–∑–¥–∞–π—Ç–µ example —Ñ–∞–π–ª—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ Docker —Å–µ—Ç–∏

## üìÖ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (4 –Ω–µ–¥–µ–ª–∏)

### –ù–µ–¥–µ–ª—è 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL/TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
- [ ] –ê—É–¥–∏—Ç —Å–µ—Ç–µ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ù–µ–¥–µ–ª—è 2: –í—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ health checks –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Backrest
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ restart policies

### –ù–µ–¥–µ–ª—è 3: –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PostgreSQL
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
- [ ] –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–µ–¥–µ–ª—è 4: –ù–∏–∑–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- [ ] –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

## üìã –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω—É

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚úÖ
- [ ] –í—Å–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –∑–∞–º–µ–Ω–µ–Ω—ã
- [ ] SSL/TLS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã (600 –¥–ª—è .env)
- [ ] –°–µ—Ç–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- [ ] Firewall –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚ö°
- [ ] –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å üõ°Ô∏è
- [ ] Health checks –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- [ ] Restart policies –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
- [ ] Disaster recovery –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚öôÔ∏è
- [ ] Docker Compose —Ñ–∞–π–ª—ã –≤–∞–ª–∏–¥–Ω—ã
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Volumes –∏ networks –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞
- [ ] –ü—Ä–æ—Ü–µ–¥—É—Ä—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

**–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω**: $(date)
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**: ERNI-KI Quick Audit Script
**–í–µ—Ä—Å–∏—è**: 1.0
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞

EOF
}

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –≤ –æ—Ç—á–µ—Ç
add_issues_section() {
    local section_title="$1"
    shift
    local issues=("$@")

    cat >> "$AUDIT_REPORT_FILE" << EOF

## $section_title

EOF

    if [ ${#issues[@]} -eq 0 ]; then
        echo "‚úÖ –ü—Ä–æ–±–ª–µ–º—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã" >> "$AUDIT_REPORT_FILE"
    else
        echo "### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:" >> "$AUDIT_REPORT_FILE"
        echo "" >> "$AUDIT_REPORT_FILE"
        for issue in "${issues[@]}"; do
            IFS='|' read -r severity title description recommendation <<< "$issue"
            echo "#### [$severity] $title" >> "$AUDIT_REPORT_FILE"
            echo "**–û–ø–∏—Å–∞–Ω–∏–µ**: $description" >> "$AUDIT_REPORT_FILE"
            echo "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: $recommendation" >> "$AUDIT_REPORT_FILE"
            echo "" >> "$AUDIT_REPORT_FILE"
        done
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log "–ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –∞—É–¥–∏—Ç–∞ ERNI-KI..."
    echo "–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞: $AUDIT_DATE"
    echo "–û—Ç—á–µ—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $AUDIT_REPORT_FILE"
    echo ""

    collect_system_info
    audit_security
    audit_performance
    audit_reliability
    audit_configuration
    count_issues_by_severity
    generate_report

    echo ""
    success "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
    echo "–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $AUDIT_REPORT_FILE"
    echo ""
    echo "–°–≤–æ–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º:"
    echo "  üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: $CRITICAL_COUNT"
    echo "  üü† –í—ã—Å–æ–∫–∏–µ: $HIGH_COUNT"
    echo "  üü° –°—Ä–µ–¥–Ω–∏–µ: $MEDIUM_COUNT"
    echo "  üü¢ –ù–∏–∑–∫–∏–µ: $LOW_COUNT"
    echo "  üìä –í—Å–µ–≥–æ: $((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))"
}

# –ó–∞–ø—É—Å–∫ –∞—É–¥–∏—Ç–∞
main "$@"
