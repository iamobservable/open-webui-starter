#!/bin/bash
# –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ ERNI-KI
# –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —à–∞–≥–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Backrest

set -euo pipefail

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
check_prerequisites() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose
    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        error "Docker Compose –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
    if [ ! -f "compose.yml" ]; then
        error "–§–∞–π–ª compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ ERNI-KI"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Backrest
    if ! docker-compose ps backrest | grep -q "Up"; then
        warning "Backrest –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞–µ–º..."
        docker-compose up -d backrest
        sleep 15
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    if ! curl -s -o /dev/null -w "%{http_code}" http://localhost:9898/ | grep -q "200"; then
        error "Backrest –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    fi
    
    success "–í—Å–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
}

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–∞
setup_backup_directory() {
    log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–∞..."
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    mkdir -p .config-backup
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ .gitignore
    if ! grep -q ".config-backup/" .gitignore 2>/dev/null; then
        echo ".config-backup/" >> .gitignore
        success "–î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .config-backup –≤ .gitignore"
    fi
    
    success "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
get_credentials() {
    log "–ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
    
    if [ ! -f ".backrest_secrets" ]; then
        error "–§–∞–π–ª .backrest_secrets –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ ./scripts/backrest-setup.sh"
    fi
    
    BACKREST_PASSWORD=$(grep "BACKREST_PASSWORD=" .backrest_secrets | cut -d'=' -f2)
    RESTIC_PASSWORD=$(grep "RESTIC_PASSWORD=" .backrest_secrets | cut -d'=' -f2)
    
    if [ -z "$BACKREST_PASSWORD" ] || [ -z "$RESTIC_PASSWORD" ]; then
        error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
    fi
    
    success "–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
}

# –ü–æ–∫–∞–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
show_setup_instructions() {
    log "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ..."
    
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    –ù–ê–°–¢–†–û–ô–ö–ê BACKREST –ß–ï–†–ï–ó –í–ï–ë-–ò–ù–¢–ï–†–§–ï–ô–°                   ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "üåê URL: http://localhost:9898"
    echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: admin"
    echo "üîë –ü–∞—Ä–æ–ª—å: $BACKREST_PASSWORD"
    echo ""
    echo "üìã –®–ê–ì–ò –ù–ê–°–¢–†–û–ô–ö–ò:"
    echo ""
    echo "1Ô∏è‚É£  –°–û–ó–î–ê–ù–ò–ï –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø:"
    echo "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ 'Add Repository'"
    echo "   ‚Ä¢ Repository ID: erni-ki-local"
    echo "   ‚Ä¢ Repository URI: /backup-sources/.config-backup"
    echo "   ‚Ä¢ Password: $RESTIC_PASSWORD"
    echo "   ‚Ä¢ Prune Schedule: 0 3 * * *"
    echo "   ‚Ä¢ Check Schedule: 0 4 * * 0"
    echo ""
    echo "2Ô∏è‚É£  –°–û–ó–î–ê–ù–ò–ï –ü–õ–ê–ù–ê –ë–≠–ö–ê–ü–ê:"
    echo "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ 'Add Plan'"
    echo "   ‚Ä¢ Plan ID: erni-ki-critical-data"
    echo "   ‚Ä¢ Repository: erni-ki-local"
    echo "   ‚Ä¢ Paths:"
    echo "     - /backup-sources/env"
    echo "     - /backup-sources/conf"
    echo "     - /backup-sources/data/postgres"
    echo "     - /backup-sources/data/openwebui"
    echo "     - /backup-sources/data/ollama"
    echo "   ‚Ä¢ Excludes: *.log, *.tmp, **/cache/**, **/temp/**, **/.git/**"
    echo "   ‚Ä¢ Schedule: 0 2 * * *"
    echo "   ‚Ä¢ Retention: Daily=7, Weekly=4"
    echo ""
    echo "3Ô∏è‚É£  –°–û–ó–î–ê–ù–ò–ï –¢–ï–°–¢–û–í–û–ì–û –ë–≠–ö–ê–ü–ê:"
    echo "   ‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ 'Plans'"
    echo "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ 'Backup Now' –¥–ª—è –ø–ª–∞–Ω–∞ erni-ki-critical-data"
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë  –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏...                  ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
}

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
wait_for_setup() {
    echo ""
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ..."
    echo ""
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
verify_backup() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ ! -d ".config-backup" ] || [ ! "$(ls -A .config-backup 2>/dev/null)" ]; then
        warning "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .config-backup –ø—É—Å—Ç–∞"
        echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
        echo "1. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω"
        echo "2. –ë—ç–∫–∞–ø –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"
        echo "3. –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
    BACKUP_SIZE=$(du -sh .config-backup | cut -f1)
    success "–†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞: $BACKUP_SIZE"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –ø–æ–º–æ—â—å—é restic
    if command -v restic &> /dev/null; then
        export RESTIC_REPOSITORY=".config-backup"
        export RESTIC_PASSWORD="$RESTIC_PASSWORD"
        
        if restic snapshots &>/dev/null; then
            success "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π restic –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
            
            echo ""
            log "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–Ω–∞–ø—à–æ—Ç–∞—Ö ==="
            restic snapshots --compact
        else
            warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π restic"
        fi
    else
        log "restic –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º Docker –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏..."
        
        if docker run --rm \
            -v "$(pwd)/.config-backup:/repo" \
            -e RESTIC_REPOSITORY=/repo \
            -e RESTIC_PASSWORD="$RESTIC_PASSWORD" \
            restic/restic:latest \
            snapshots &>/dev/null; then
            
            success "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π restic –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ Docker)"
        else
            warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —á–µ—Ä–µ–∑ Docker"
        fi
    fi
    
    return 0
}

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
create_setup_report() {
    log "–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ..."
    
    REPORT_FILE="backup-setup-report-$(date +%Y%m%d_%H%M%S).md"
    
    cat > "$REPORT_FILE" << EOF
# –û—Ç—á–µ—Ç –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ ERNI-KI

**–î–∞—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**: $(date)
**–•–æ—Å—Ç**: $(hostname)

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Backrest**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
2. **–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏**: .config-backup —Å–æ–∑–¥–∞–Ω–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ .gitignore
3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è**: erni-ki-local
4. **–ü–ª–∞–Ω –±—ç–∫–∞–ø–∞**: erni-ki-critical-data
5. **–¢–µ—Å—Ç–æ–≤—ã–π –±—ç–∫–∞–ø**: $([ -d ".config-backup" ] && [ "$(ls -A .config-backup)" ] && echo "–í—ã–ø–æ–ª–Ω–µ–Ω" || echo "–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω")

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞**: $([ -d ".config-backup" ] && du -sh .config-backup | cut -f1 || echo "N/A")
- **URL Backrest**: http://localhost:9898
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: admin

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- **ID**: erni-ki-local
- **–ü—É—Ç—å**: /backup-sources/.config-backup
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏**: –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 4:00

### –ü–ª–∞–Ω –±—ç–∫–∞–ø–∞
- **ID**: erni-ki-critical-data
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 2:00
- **Retention**: 7 –¥–Ω–µ–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö, 4 –Ω–µ–¥–µ–ª–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö

### –ü—É—Ç–∏ –¥–ª—è –±—ç–∫–∞–ø–∞
- env/ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
- conf/ (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤)
- data/postgres/ (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
- data/openwebui/ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)
- data/ollama/ (–º–æ–¥–µ–ª–∏ –ò–ò)

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –Ω–µ—É–¥–∞—á–Ω—ã–µ –±—ç–∫–∞–ø—ã
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–µ–≥—É–ª—è—Ä–Ω–æ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
3. **–í–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ**: –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É S3/B2 –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –û–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å docs/local-backup-restore-guide.md

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

\`\`\`bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±—ç–∫–∞–ø–∞
./scripts/check-local-backup.sh

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Backrest
./scripts/backrest-management.sh status

# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å restic
./scripts/check-local-backup.sh --full
\`\`\`

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –ü–∞—Ä–æ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ .backrest_secrets
- ‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .config-backup –∏—Å–∫–ª—é—á–µ–Ω–∞ –∏–∑ Git
- ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã —Å –ø–æ–º–æ—â—å—é restic

---

**–í–∞–∂–Ω–æ**: –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª .backrest_secrets –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ!
EOF

    success "–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $REPORT_FILE"
}

# –§–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
show_final_instructions() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                           –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!                              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    success "–õ–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø ERNI-KI –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
    echo ""
    echo "üìã –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´:"
    echo ""
    echo "   ./scripts/check-local-backup.sh           # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—ç–∫–∞–ø–∞"
    echo "   ./scripts/backrest-management.sh status   # –°—Ç–∞—Ç—É—Å Backrest"
    echo "   ./scripts/check-local-backup.sh --report  # –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç"
    echo ""
    echo "üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø:"
    echo ""
    echo "   docs/backrest-quick-setup-guide.md        # –ë—ã—Å—Ç—Ä–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ"
    echo "   docs/local-backup-restore-guide.md        # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é"
    echo ""
    echo "üåê –í–ï–ë-–ò–ù–¢–ï–†–§–ï–ô–°:"
    echo ""
    echo "   http://localhost:9898                      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏"
    echo ""
    echo "üîê –£–ß–ï–¢–ù–´–ï –î–ê–ù–ù–´–ï:"
    echo ""
    echo "   cat .backrest_secrets                      # –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–∞—Ä–æ–ª–µ–π"
    echo ""
    warning "–í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª .backrest_secrets –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ!"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log "–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ ERNI-KI..."
    
    check_prerequisites
    setup_backup_directory
    get_credentials
    show_setup_instructions
    
    # –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    if command -v xdg-open &> /dev/null; then
        xdg-open "http://localhost:9898" &>/dev/null &
    elif command -v open &> /dev/null; then
        open "http://localhost:9898" &>/dev/null &
    fi
    
    wait_for_setup
    
    if verify_backup; then
        create_setup_report
        show_final_instructions
    else
        echo ""
        warning "–ë—ç–∫–∞–ø –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ"
        echo ""
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
        echo "1. –°–æ–∑–¥–∞–Ω –ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ"
        echo "2. –°–æ–∑–¥–∞–Ω –ª–∏ –ø–ª–∞–Ω –±—ç–∫–∞–ø–∞"
        echo "3. –í—ã–ø–æ–ª–Ω–µ–Ω –ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π –±—ç–∫–∞–ø"
        echo ""
        echo "–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
        echo "  ./scripts/check-local-backup.sh"
    fi
}

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
main "$@"
