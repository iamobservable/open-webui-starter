#!/bin/bash
# –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ–¥–∞–∫—à–Ω –∞—É–¥–∏—Ç —Å–∏—Å—Ç–µ–º—ã ERNI-KI
# –ü—Ä–æ–≤–æ–¥–∏—Ç –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

set -euo pipefail

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

critical() {
    echo -e "${RED}[CRITICAL]${NC} $1"
}

section() {
    echo -e "${PURPLE}[SECTION]${NC} $1"
}

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á–µ—Ç–∞
AUDIT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
AUDIT_REPORT_FILE="audit-report-$(date +%Y%m%d_%H%M%S).md"
SECURITY_ISSUES=()
PERFORMANCE_ISSUES=()
RELIABILITY_ISSUES=()
CONFIG_ISSUES=()
CRITICAL_COUNT=0
HIGH_COUNT=0
MEDIUM_COUNT=0
LOW_COUNT=0

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –≤ –æ—Ç—á–µ—Ç
add_issue() {
    local category="$1"
    local severity="$2"
    local title="$3"
    local description="$4"
    local recommendation="$5"

    case $severity in
        "CRITICAL") ((CRITICAL_COUNT++)) ;;
        "HIGH") ((HIGH_COUNT++)) ;;
        "MEDIUM") ((MEDIUM_COUNT++)) ;;
        "LOW") ((LOW_COUNT++)) ;;
    esac

    local issue="**[$severity]** $title|$description|$recommendation"

    case $category in
        "SECURITY") SECURITY_ISSUES+=("$issue") ;;
        "PERFORMANCE") PERFORMANCE_ISSUES+=("$issue") ;;
        "RELIABILITY") RELIABILITY_ISSUES+=("$issue") ;;
        "CONFIG") CONFIG_ISSUES+=("$issue") ;;
    esac
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
check_prerequisites() {
    section "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
    if ! command -v docker &> /dev/null; then
        critical "Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        add_issue "CONFIG" "CRITICAL" "Docker –Ω–µ –Ω–∞–π–¥–µ–Ω" "Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ" "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose
    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        critical "Docker Compose –Ω–µ –Ω–∞–π–¥–µ–Ω"
        add_issue "CONFIG" "CRITICAL" "Docker Compose –Ω–µ –Ω–∞–π–¥–µ–Ω" "Docker Compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Compose"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
    if [ ! -f "compose.yml" ]; then
        critical "–§–∞–π–ª compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
        add_issue "CONFIG" "CRITICAL" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç compose.yml" "–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω" "–°–æ–∑–¥–∞–π—Ç–µ compose.yml –∏–∑ compose.yml.example"
        return 1
    fi

    success "–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
    return 0
}

# –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
audit_security() {
    section "–ê–£–î–ò–¢ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–∞–º–∏..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–æ–≤
    if find env/ -name "*.env" -exec grep -l "password\|secret\|key" {} \; 2>/dev/null | grep -q .; then
        warning "–ù–∞–π–¥–µ–Ω—ã —Å–µ–∫—Ä–µ—Ç—ã –≤ .env —Ñ–∞–π–ª–∞—Ö"

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ (–∏—Å–∫–ª—é—á–∞—è example —Ñ–∞–π–ª—ã)
        if grep -r "CHANGE_BEFORE_GOING_LIVE\|password123\|admin123" env/ --exclude="*.example" 2>/dev/null; then
            critical "–ù–∞–π–¥–µ–Ω—ã –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏"
            add_issue "SECURITY" "CRITICAL" "–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏" "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–∞–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –≤ production —Ñ–∞–π–ª–∞—Ö" "–ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ"
        fi

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ (–∏—Å–∫–ª—é—á–∞—è example —Ñ–∞–π–ª—ã)
        if find env/ -name "*.env" -not -name "*.example" -not -perm 600 2>/dev/null | grep -q .; then
            error "–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ .env —Ñ–∞–π–ª–∞–º"
            add_issue "SECURITY" "HIGH" "–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞" "–§–∞–π–ª—ã —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –∏–º–µ—é—Ç —Å–ª–∏—à–∫–æ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–∞–≤–∞" "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∞ 600 –¥–ª—è –≤—Å–µ—Ö .env —Ñ–∞–π–ª–æ–≤"
        fi
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Docker..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ privileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    if grep -q "privileged.*true" compose.yml 2>/dev/null; then
        error "–ù–∞–π–¥–µ–Ω—ã privileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
        add_issue "SECURITY" "HIGH" "Privileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã —Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏" "–£–¥–∞–ª–∏—Ç–µ privileged: true –∏–ª–∏ –æ–±–æ—Å–Ω—É–π—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Docker socket
    if grep -q "/var/run/docker.sock" compose.yml 2>/dev/null; then
        warning "Docker socket –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
        add_issue "SECURITY" "MEDIUM" "Docker socket –¥–æ—Å—Ç—É–ø" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ Docker socket" "–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º —Å–µ—Ä–≤–∏—Å–∞–º"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤
    if grep -E "ports:" compose.yml | grep -E "0\.0\.0\.0|::" 2>/dev/null; then
        warning "–ü–æ—Ä—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤"
        add_issue "SECURITY" "MEDIUM" "–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã" "–°–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö" "–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç–∞–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL/TLS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if ! grep -q "ssl\|tls\|https" conf/nginx/ 2>/dev/null; then
        error "SSL/TLS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        add_issue "SECURITY" "HIGH" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç SSL/TLS" "–í–µ–±-—Ç—Ä–∞—Ñ–∏–∫ –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω" "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL/TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã"
    fi

    success "–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω"
}

# –ê—É–¥–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
audit_performance() {
    section "–ê–£–î–ò–¢ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–∏—Å—Ç–µ–º—ã
    log "–ê–Ω–∞–ª–∏–∑ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 | cut -d'.' -f1)
    if [ "$CPU_USAGE" -gt 80 ] 2>/dev/null; then
        warning "–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU: ${CPU_USAGE}%"
        add_issue "PERFORMANCE" "MEDIUM" "–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ CPU" "CPU –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ ${CPU_USAGE}%" "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
    MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
    if [ "$MEMORY_USAGE" -gt 85 ] 2>/dev/null; then
        warning "–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: ${MEMORY_USAGE}%"
        add_issue "PERFORMANCE" "MEDIUM" "–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏" "–û–ó–£ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ ${MEMORY_USAGE}%" "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –û–ó–£"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
    DISK_USAGE=$(df -h . | awk 'NR==2 {print $5}' | cut -d'%' -f1)
    if [ "$DISK_USAGE" -gt 85 ]; then
        error "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–∞–ª–æ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞: ${DISK_USAGE}%"
        add_issue "PERFORMANCE" "HIGH" "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞" "–î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${DISK_USAGE}%" "–û—á–∏—Å—Ç–∏—Ç–µ –¥–∏—Å–∫ –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –æ–±—ä–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Docker —Ä–µ—Å—É—Ä—Å–æ–≤
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."

    if ! grep -q "mem_limit\|cpus\|memory" compose.yml 2>/dev/null; then
        warning "–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
        add_issue "PERFORMANCE" "MEDIUM" "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã" "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ mem_limit –∏ cpus –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PostgreSQL..."

    if [ -f "conf/postgres/postgresql.conf" ]; then
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ shared_buffers
        if ! grep -q "shared_buffers" conf/postgres/postgresql.conf 2>/dev/null; then
            warning "shared_buffers –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            add_issue "PERFORMANCE" "MEDIUM" "PostgreSQL –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω" "shared_buffers –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω" "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ shared_buffers = 25% –æ—Ç –û–ó–£"
        fi
    fi

    success "–ê—É–¥–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω"
}

# –ê—É–¥–∏—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
audit_reliability() {
    section "–ê–£–î–ò–¢ –ù–ê–î–ï–ñ–ù–û–°–¢–ò"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ health checks
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ health checks..."

    SERVICES_WITHOUT_HEALTHCHECK=()
    while IFS= read -r service; do
        if ! grep -A 10 "^  $service:" compose.yml | grep -q "healthcheck:" 2>/dev/null; then
            SERVICES_WITHOUT_HEALTHCHECK+=("$service")
        fi
    done < <(grep -E "^  [a-zA-Z].*:" compose.yml | sed 's/://g' | awk '{print $1}')

    if [ ${#SERVICES_WITHOUT_HEALTHCHECK[@]} -gt 0 ]; then
        warning "–°–µ—Ä–≤–∏—Å—ã –±–µ–∑ health checks: ${SERVICES_WITHOUT_HEALTHCHECK[*]}"
        add_issue "RELIABILITY" "MEDIUM" "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç health checks" "–°–µ—Ä–≤–∏—Å—ã ${SERVICES_WITHOUT_HEALTHCHECK[*]} –Ω–µ –∏–º–µ—é—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–¥–æ—Ä–æ–≤—å—è" "–î–æ–±–∞–≤—å—Ç–µ healthcheck –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ restart policies
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞..."

    if grep -c "restart:" compose.yml | grep -q "0"; then
        warning "–ù–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–º–µ—é—Ç –ø–æ–ª–∏—Ç–∏–∫—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"
        add_issue "RELIABILITY" "MEDIUM" "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç restart policies" "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" "–î–æ–±–∞–≤—å—Ç–µ restart: unless-stopped –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è..."

    if [ ! -d ".config-backup" ] || [ ! "$(ls -A .config-backup 2>/dev/null)" ]; then
        error "–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
        add_issue "RELIABILITY" "HIGH" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ" "Backrest –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö" "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è..."

    if ! grep -q "logging:" compose.yml 2>/dev/null; then
        warning "–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ"
        add_issue "RELIABILITY" "LOW" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ" "–õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã" "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ logging driver –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    fi

    success "–ê—É–¥–∏—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω"
}

# –ê—É–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
audit_configuration() {
    section "–ê–£–î–ò–¢ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose –≤–µ—Ä—Å–∏–∏
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Docker Compose —Ñ–∞–π–ª–∞..."

    COMPOSE_VERSION=$(grep "version:" compose.yml | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
    if [ -z "$COMPOSE_VERSION" ]; then
        warning "–í–µ—Ä—Å–∏—è Docker Compose –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        add_issue "CONFIG" "LOW" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–µ—Ä—Å–∏—è Compose" "–í–µ—Ä—Å–∏—è Docker Compose —Ñ–∞–π–ª–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞" "–î–æ–±–∞–≤—å—Ç–µ version: '3.8' –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞"
    elif [[ "$COMPOSE_VERSION" < "3.7" ]]; then
        warning "–£—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è Docker Compose: $COMPOSE_VERSION"
        add_issue "CONFIG" "MEDIUM" "–£—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è Compose" "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ—Ä—Å–∏—è $COMPOSE_VERSION" "–û–±–Ω–æ–≤–∏—Ç–µ –¥–æ –≤–µ—Ä—Å–∏–∏ 3.8 –∏–ª–∏ –≤—ã—à–µ"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è example —Ñ–∞–π–ª–æ–≤
    for env_file in env/*.env; do
        if [ -f "$env_file" ]; then
            example_file="${env_file}.example"
            if [ ! -f "$example_file" ]; then
                warning "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç example —Ñ–∞–π–ª –¥–ª—è $env_file"
                add_issue "CONFIG" "LOW" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç example —Ñ–∞–π–ª" "–ù–µ—Ç $example_file" "–°–æ–∑–¥–∞–π—Ç–µ example —Ñ–∞–π–ª —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
            fi
        fi
    done

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ volumes
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ volumes..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bind mounts –≤ production
    if grep -E "^\s*-\s*\./.*:" compose.yml | grep -v ":ro" 2>/dev/null; then
        warning "–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è bind mounts –±–µ–∑ read-only"
        add_issue "CONFIG" "MEDIUM" "–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ bind mounts" "Bind mounts –±–µ–∑ :ro –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏" "–î–æ–±–∞–≤—å—Ç–µ :ro –¥–ª—è read-only bind mounts –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ networks
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

    if ! grep -q "networks:" compose.yml 2>/dev/null; then
        warning "–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Ç–∏"
        add_issue "CONFIG" "LOW" "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Ç–∏" "–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ default —Å–µ—Ç–∏" "–°–æ–∑–¥–∞–π—Ç–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ç–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø —Å–µ—Ä–≤–∏—Å–æ–≤"
    fi

    success "–ê—É–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞—É–¥–∏—Ç–∞
main() {
    log "–ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–æ–¥–∞–∫—à–Ω –∞—É–¥–∏—Ç–∞ ERNI-KI..."
    echo "–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞: $AUDIT_DATE"
    echo "–û—Ç—á–µ—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $AUDIT_REPORT_FILE"
    echo ""

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
    if ! check_prerequisites; then
        error "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏"
        exit 1
    fi

    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ–≤
    audit_security
    echo ""
    audit_performance
    echo ""
    audit_reliability
    echo ""
    audit_configuration

    echo ""
    section "–ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–ê"
    generate_report

    echo ""
    success "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
    echo "–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $AUDIT_REPORT_FILE"
    echo ""
    echo "–°–≤–æ–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º:"
    echo "  üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: $CRITICAL_COUNT"
    echo "  üü† –í—ã—Å–æ–∫–∏–µ: $HIGH_COUNT"
    echo "  üü° –°—Ä–µ–¥–Ω–∏–µ: $MEDIUM_COUNT"
    echo "  üü¢ –ù–∏–∑–∫–∏–µ: $LOW_COUNT"
}

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
generate_report() {
    log "–°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞..."

    cat > "$AUDIT_REPORT_FILE" << EOF
# üîç –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ–¥–∞–∫—à–Ω –∞—É–¥–∏—Ç ERNI-KI

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞**: $AUDIT_DATE
**–°–∏—Å—Ç–µ–º–∞**: $(hostname)
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: $(whoami)
**–í–µ—Ä—Å–∏—è Docker**: $(docker --version 2>/dev/null || echo "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
**–í–µ—Ä—Å–∏—è Docker Compose**: $(docker-compose --version 2>/dev/null || docker compose version 2>/dev/null || echo "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

## üìä –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ | –í—ã—Å–æ–∫–∏–µ | –°—Ä–µ–¥–Ω–∏–µ | –ù–∏–∑–∫–∏–µ | –í—Å–µ–≥–æ |
|-----------|-------------|---------|---------|--------|-------|
| üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | $(echo "${SECURITY_ISSUES[@]}" | grep -o "CRITICAL" | wc -l) | $(echo "${SECURITY_ISSUES[@]}" | grep -o "HIGH" | wc -l) | $(echo "${SECURITY_ISSUES[@]}" | grep -o "MEDIUM" | wc -l) | $(echo "${SECURITY_ISSUES[@]}" | grep -o "LOW" | wc -l) | ${#SECURITY_ISSUES[@]} |
| ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | $(echo "${PERFORMANCE_ISSUES[@]}" | grep -o "CRITICAL" | wc -l) | $(echo "${PERFORMANCE_ISSUES[@]}" | grep -o "HIGH" | wc -l) | $(echo "${PERFORMANCE_ISSUES[@]}" | grep -o "MEDIUM" | wc -l) | $(echo "${PERFORMANCE_ISSUES[@]}" | grep -o "LOW" | wc -l) | ${#PERFORMANCE_ISSUES[@]} |
| üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | $(echo "${RELIABILITY_ISSUES[@]}" | grep -o "CRITICAL" | wc -l) | $(echo "${RELIABILITY_ISSUES[@]}" | grep -o "HIGH" | wc -l) | $(echo "${RELIABILITY_ISSUES[@]}" | grep -o "MEDIUM" | wc -l) | $(echo "${RELIABILITY_ISSUES[@]}" | grep -o "LOW" | wc -l) | ${#RELIABILITY_ISSUES[@]} |
| ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | $(echo "${CONFIG_ISSUES[@]}" | grep -o "CRITICAL" | wc -l) | $(echo "${CONFIG_ISSUES[@]}" | grep -o "HIGH" | wc -l) | $(echo "${CONFIG_ISSUES[@]}" | grep -o "MEDIUM" | wc -l) | $(echo "${CONFIG_ISSUES[@]}" | grep -o "LOW" | wc -l) | ${#CONFIG_ISSUES[@]} |
| **–ò–¢–û–ì–û** | **$CRITICAL_COUNT** | **$HIGH_COUNT** | **$MEDIUM_COUNT** | **$LOW_COUNT** | **$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))** |

## üéØ –û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω—É

EOF

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—â–µ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    if [ $CRITICAL_COUNT -eq 0 ] && [ $HIGH_COUNT -eq 0 ]; then
        echo "‚úÖ **–ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ù–£** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç" >> "$AUDIT_REPORT_FILE"
    elif [ $CRITICAL_COUNT -eq 0 ] && [ $HIGH_COUNT -le 2 ]; then
        echo "‚ö†Ô∏è **–£–°–õ–û–í–ù–û –ì–û–¢–û–í** - –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –≤—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã" >> "$AUDIT_REPORT_FILE"
    else
        echo "‚ùå **–ù–ï –ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ù–£** - –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º" >> "$AUDIT_REPORT_FILE"
    fi

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
    add_security_section
    add_performance_section
    add_reliability_section
    add_configuration_section
    add_recommendations_section
    add_action_plan_section

    success "–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $AUDIT_REPORT_FILE"
}

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –æ—Ç—á–µ—Ç–∞
add_security_section() {
    cat >> "$AUDIT_REPORT_FILE" << EOF

## üîí –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

EOF

    if [ ${#SECURITY_ISSUES[@]} -eq 0 ]; then
        echo "‚úÖ –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã" >> "$AUDIT_REPORT_FILE"
    else
        echo "### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:" >> "$AUDIT_REPORT_FILE"
        echo "" >> "$AUDIT_REPORT_FILE"
        for issue in "${SECURITY_ISSUES[@]}"; do
            IFS='|' read -r title description recommendation <<< "$issue"
            echo "#### $title" >> "$AUDIT_REPORT_FILE"
            echo "**–û–ø–∏—Å–∞–Ω–∏–µ**: $description" >> "$AUDIT_REPORT_FILE"
            echo "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: $recommendation" >> "$AUDIT_REPORT_FILE"
            echo "" >> "$AUDIT_REPORT_FILE"
        done
    fi
}

add_performance_section() {
    cat >> "$AUDIT_REPORT_FILE" << EOF

## ‚ö° –ê—É–¥–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
- **CPU**: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)% –∑–∞–≥—Ä—É–∂–µ–Ω
- **–ü–∞–º—è—Ç—å**: $(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
- **–î–∏—Å–∫**: $(df -h . | awk 'NR==2 {print $5}') –∑–∞–ø–æ–ª–Ω–µ–Ω

EOF

    if [ ${#PERFORMANCE_ISSUES[@]} -eq 0 ]; then
        echo "‚úÖ –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã" >> "$AUDIT_REPORT_FILE"
    else
        echo "### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:" >> "$AUDIT_REPORT_FILE"
        echo "" >> "$AUDIT_REPORT_FILE"
        for issue in "${PERFORMANCE_ISSUES[@]}"; do
            IFS='|' read -r title description recommendation <<< "$issue"
            echo "#### $title" >> "$AUDIT_REPORT_FILE"
            echo "**–û–ø–∏—Å–∞–Ω–∏–µ**: $description" >> "$AUDIT_REPORT_FILE"
            echo "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: $recommendation" >> "$AUDIT_REPORT_FILE"
            echo "" >> "$AUDIT_REPORT_FILE"
        done
    fi
}

add_reliability_section() {
    cat >> "$AUDIT_REPORT_FILE" << EOF

## üõ°Ô∏è –ê—É–¥–∏—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

EOF

    if [ ${#RELIABILITY_ISSUES[@]} -eq 0 ]; then
        echo "‚úÖ –ü—Ä–æ–±–ª–µ–º—ã –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã" >> "$AUDIT_REPORT_FILE"
    else
        echo "### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:" >> "$AUDIT_REPORT_FILE"
        echo "" >> "$AUDIT_REPORT_FILE"
        for issue in "${RELIABILITY_ISSUES[@]}"; do
            IFS='|' read -r title description recommendation <<< "$issue"
            echo "#### $title" >> "$AUDIT_REPORT_FILE"
            echo "**–û–ø–∏—Å–∞–Ω–∏–µ**: $description" >> "$AUDIT_REPORT_FILE"
            echo "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: $recommendation" >> "$AUDIT_REPORT_FILE"
            echo "" >> "$AUDIT_REPORT_FILE"
        done
    fi
}

add_configuration_section() {
    cat >> "$AUDIT_REPORT_FILE" << EOF

## ‚öôÔ∏è –ê—É–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

EOF

    if [ ${#CONFIG_ISSUES[@]} -eq 0 ]; then
        echo "‚úÖ –ü—Ä–æ–±–ª–µ–º—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã" >> "$AUDIT_REPORT_FILE"
    else
        echo "### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:" >> "$AUDIT_REPORT_FILE"
        echo "" >> "$AUDIT_REPORT_FILE"
        for issue in "${CONFIG_ISSUES[@]}"; do
            IFS='|' read -r title description recommendation <<< "$issue"
            echo "#### $title" >> "$AUDIT_REPORT_FILE"
            echo "**–û–ø–∏—Å–∞–Ω–∏–µ**: $description" >> "$AUDIT_REPORT_FILE"
            echo "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: $recommendation" >> "$AUDIT_REPORT_FILE"
            echo "" >> "$AUDIT_REPORT_FILE"
        done
    fi
}

add_recommendations_section() {
    cat >> "$AUDIT_REPORT_FILE" << EOF

## üí° –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
- –ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL/TLS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í—ã—Å–æ–∫–∏–π)
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –î–æ–±–∞–≤—å—Ç–µ health checks –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–°—Ä–µ–¥–Ω–∏–π)
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥
- –î–æ–±–∞–≤—å—Ç–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4 (–ù–∏–∑–∫–∏–π)
- –û–±–Ω–æ–≤–∏—Ç–µ –≤–µ—Ä—Å–∏–∏ Docker Compose
- –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Ç–∏
- –î–æ–±–∞–≤—å—Ç–µ example —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

EOF
}

add_action_plan_section() {
    cat >> "$AUDIT_REPORT_FILE" << EOF

## üìÖ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –ù–µ–¥–µ–ª—è 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã)
- [ ] –ó–∞–º–µ–Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL/TLS
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ù–µ–¥–µ–ª—è 2 (–í—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã)
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–µ—Å—É—Ä—Å–æ–≤
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ health checks
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

### –ù–µ–¥–µ–ª—è 3 (–°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã)
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–µ–¥–µ–ª—è 4 (–ù–∏–∑–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è)
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- [ ] –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω—É

## üìã –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω—É

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [ ] –í—Å–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –∑–∞–º–µ–Ω–µ–Ω—ã
- [ ] SSL/TLS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] –°–µ—Ç–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- [ ] –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- [ ] –†–µ—Å—É—Ä—Å—ã —Å–∏—Å—Ç–µ–º—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- [ ] Health checks –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- [ ] Restart policies –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Disaster recovery –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- [ ] Docker Compose —Ñ–∞–π–ª—ã –≤–∞–ª–∏–¥–Ω—ã
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Volumes –∏ networks –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞
- [ ] –ü—Ä–æ—Ü–µ–¥—É—Ä—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

**–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω**: $(date)
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**: ERNI-KI Comprehensive Audit Script
**–í–µ—Ä—Å–∏—è**: 1.0

EOF
}

# –ó–∞–ø—É—Å–∫ –∞—É–¥–∏—Ç–∞
main "$@"
