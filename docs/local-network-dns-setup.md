# Настройка локального DNS для ERNI-KI в корпоративной сети

**Дата**: 2025-10-27  
**Цель**: Настроить доступ к `ki.erni-gruppe.ch` для всех компьютеров в
локальной сети 192.168.62.0/24  
**Статус**: ТРЕБУЕТСЯ ДЕЙСТВИЕ

---

## ТЕКУЩАЯ СИТУАЦИЯ

### Сетевая инфраструктура

| Компонент      | IP адрес        | Статус      | Роль                                    |
| -------------- | --------------- | ----------- | --------------------------------------- |
| ERNI-KI сервер | 192.168.62.153  | ✅ Работает | Веб-сервер (nginx 80/443)               |
| Роутер LANCOM  | 192.168.62.1    | ✅ Доступен | Шлюз, DNS форвардер                     |
| DNS сервер     | 192.168.62.32   | ✅ Работает | Основной DNS (недоступен для настройки) |
| Резервный DNS  | 185.242.202.231 | ✅ Работает | Внешний DNS                             |

### DNS конфигурация

**Текущие DNS серверы** (из DHCP):

```
Primary DNS:   192.168.62.32
Secondary DNS: 185.242.202.231
Search domain: intern
```

**Проблема**:

- DNS сервер 192.168.62.32 НЕ содержит запись для `ki.erni-gruppe.ch`
- SSH доступ к 192.168.62.32 недоступен (Connection refused)
- Тип DNS сервера: вероятно Windows Server DNS (TTL=128)

**Результат**:

```bash
$ nslookup ki.erni-gruppe.ch 192.168.62.32
*** Can't find ki.erni-gruppe.ch: No answer
```

---

## РЕШЕНИЯ

### ВАРИАНТ 1: Запрос к IT отделу (РЕКОМЕНДУЕТСЯ) ✅

**Описание**: Попросить IT отдел добавить A запись на корпоративный DNS сервер
192.168.62.32

**Преимущества**:

- ✅ Централизованное управление DNS
- ✅ Работает для всей корпоративной сети автоматически
- ✅ Не требует дополнительных сервисов на ERNI-KI
- ✅ Стандартный подход для корпоративной среды

**Недостатки**:

- ⚠️ Требует согласования с IT отделом
- ⚠️ Время ожидания: от нескольких часов до нескольких дней

**Действия**:

#### 1.1 Подготовить запрос для IT отдела

**Тема**: Добавление DNS записи для ERNI-KI системы

**Текст запроса**:

```
Добрый день!

Прошу добавить следующую DNS запись на корпоративный DNS сервер (192.168.62.32):

Тип записи: A
Имя: ki.erni-gruppe.ch
IP адрес: 192.168.62.153
TTL: 3600 (или стандартный для локальной зоны)

Назначение: Доступ к системе ERNI-KI (Knowledge Intelligence) для сотрудников компании

Дополнительная информация:
- Сервер: 192.168.62.153 (Ubuntu 24.04, nginx)
- Порты: 80 (HTTP), 443 (HTTPS)
- SSL сертификат: Let's Encrypt (уже настроен)
- Доступ: только внутри корпоративной сети 192.168.62.0/24

Контакт для вопросов: [ВАШ EMAIL/ТЕЛЕФОН]

Спасибо!
```

#### 1.2 Проверка после добавления записи

```bash
# Очистить DNS кэш (если требуется)
sudo systemd-resolve --flush-caches

# Проверить резолвинг
nslookup ki.erni-gruppe.ch

# Проверить доступ
curl -I https://ki.erni-gruppe.ch/
```

**Ожидаемый результат**:

```
Server:		192.168.62.32
Address:	192.168.62.32#53

Name:	ki.erni-gruppe.ch
Address: 192.168.62.153
```

---

### ВАРИАНТ 2: Настройка DNS на роутере LANCOM

**Описание**: Добавить локальную DNS запись на роутере LANCOM (192.168.62.1)

**Преимущества**:

- ✅ Работает для всей сети автоматически
- ✅ Не требует дополнительных сервисов
- ✅ Быстрая настройка (5-10 минут)

**Недостатки**:

- ⚠️ Требует доступа к роутеру LANCOM
- ⚠️ Может потребоваться согласование с IT отделом

**Действия**:

#### 2.1 Доступ к WEBconfig роутера

1. Открыть браузер: `https://192.168.62.1/`
2. Ввести учетные данные администратора
3. Принять SSL сертификат роутера

#### 2.2 Добавление локальной DNS записи

**Возможные пути в меню LANCOM**:

**Вариант A**:

```
Configuration → IPv4 → DNS → Static Host Table
```

**Вариант B**:

```
Setup → TCP-IP → DNS → Static Hosts
```

**Вариант C**:

```
Advanced Settings → DNS → Local DNS Records
```

#### 2.3 Добавить запись

```
Hostname: ki.erni-gruppe.ch
IP Address: 192.168.62.153
Enabled: Yes
```

#### 2.4 Применить изменения

1. Нажать "Apply" или "Save & Activate"
2. Подождать 10-30 секунд
3. Проверить доступ

---

### ВАРИАНТ 3: Локальный DNS сервер на ERNI-KI (БЫСТРОЕ РЕШЕНИЕ)

**Описание**: Поднять dnsmasq на сервере ERNI-KI для локального DNS

**Преимущества**:

- ✅ Можно настроить СЕЙЧАС (не требует доступа к другим системам)
- ✅ Полный контроль над DNS
- ✅ Быстрая настройка (10-15 минут)

**Недостатки**:

- ⚠️ Требует изменения DNS настроек на клиентских компьютерах
- ⚠️ Или изменения DHCP настроек на роутере
- ⚠️ Дополнительный сервис на ERNI-KI

**Действия**:

#### 3.1 Установка и настройка dnsmasq

Создам Docker контейнер с dnsmasq для локального DNS.

**Файл**: `conf/dnsmasq/dnsmasq.conf`

```conf
# Слушать только на локальном интерфейсе
interface=eno1
bind-interfaces

# Не читать /etc/resolv.conf
no-resolv

# Upstream DNS серверы
server=192.168.62.32
server=185.242.202.231

# Локальная зона
domain=intern
local=/intern/

# Локальные записи
address=/ki.erni-gruppe.ch/192.168.62.153

# Кэширование
cache-size=1000

# Логирование
log-queries
log-facility=/var/log/dnsmasq.log
```

#### 3.2 Docker Compose конфигурация

Добавить в `compose.yml`:

```yaml
dnsmasq:
  image: jpillora/dnsmasq:latest
  container_name: erni-ki-dnsmasq
  restart: unless-stopped
  ports:
    - '53:53/udp'
    - '53:53/tcp'
  volumes:
    - ./conf/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro
    - ./logs/dnsmasq:/var/log:rw
  networks:
    - erni-ki-network
  cap_add:
    - NET_ADMIN
  logging:
    driver: 'json-file'
    options:
      max-size: '10m'
      max-file: '3'
```

#### 3.3 Запуск

```bash
# Создать директории
mkdir -p conf/dnsmasq logs/dnsmasq

# Создать конфигурацию (см. выше)

# Запустить контейнер
docker compose up -d dnsmasq

# Проверить статус
docker ps --filter name=dnsmasq

# Проверить логи
docker logs erni-ki-dnsmasq
```

#### 3.4 Настройка клиентов

**Вариант A: Изменить DHCP на роутере** (рекомендуется)

1. Войти в LANCOM WEBconfig
2. Изменить Primary DNS с 192.168.62.32 на 192.168.62.153
3. Клиенты получат новый DNS при следующем DHCP lease

**Вариант B: Ручная настройка на клиентах**

```bash
# Linux
sudo nmcli connection modify <connection-name> ipv4.dns "192.168.62.153"
sudo nmcli connection up <connection-name>

# Windows
# Панель управления → Сеть → Свойства адаптера → IPv4 → DNS: 192.168.62.153

# macOS
# Системные настройки → Сеть → Дополнительно → DNS → 192.168.62.153
```

---

### ВАРИАНТ 4: Временное решение через /etc/hosts

**Описание**: Обновить /etc/hosts на каждом компьютере вручную

**Преимущества**:

- ✅ Работает немедленно
- ✅ Не требует доступа к серверам

**Недостатки**:

- ❌ Не масштабируется (нужно обновлять каждый компьютер)
- ❌ Требует прав администратора на каждом компьютере
- ❌ Сложно поддерживать

**Действия**:

На каждом компьютере добавить в `/etc/hosts` (Linux/macOS) или
`C:\Windows\System32\drivers\etc\hosts` (Windows):

```
192.168.62.153 ki.erni-gruppe.ch
```

**Только для тестирования или очень малого количества компьютеров!**

---

## РЕКОМЕНДАЦИЯ

**Для корпоративной среды ERNI рекомендуется ВАРИАНТ 1 (запрос к IT отделу)**

**Обоснование**:

1. ✅ Стандартный подход для корпоративной сети
2. ✅ Централизованное управление DNS
3. ✅ Не требует дополнительных сервисов
4. ✅ Работает автоматически для всех компьютеров
5. ✅ Соответствует политикам безопасности

**Если требуется СРОЧНОЕ решение** (пока ждём IT отдел):

- Использовать **ВАРИАНТ 3** (локальный DNS на ERNI-KI)
- После получения доступа от IT отдела - переключиться на ВАРИАНТ 1

---

## ПРОВЕРКА РЕШЕНИЯ

### Тест 1: DNS резолвинг

```bash
# Очистить кэш
sudo systemd-resolve --flush-caches

# Проверить резолвинг
nslookup ki.erni-gruppe.ch

# Ожидаемый результат:
# Name:	ki.erni-gruppe.ch
# Address: 192.168.62.153
```

### Тест 2: HTTP доступ

```bash
curl -I http://ki.erni-gruppe.ch/

# Ожидаемый результат:
# HTTP/1.1 301 Moved Permanently
# Location: https://ki.erni-gruppe.ch/
```

### Тест 3: HTTPS доступ

```bash
curl -I https://ki.erni-gruppe.ch/

# Ожидаемый результат:
# HTTP/2 200
# server: nginx/1.28.0
```

### Тест 4: SSL сертификат

```bash
openssl s_client -connect ki.erni-gruppe.ch:443 -servername ki.erni-gruppe.ch 2>&1 | grep -E "subject=|issuer=|Verify"

# Ожидаемый результат:
# subject=CN = ki.erni-gruppe.ch
# issuer=C = US, O = Let's Encrypt, CN = E5
# Verify return code: 0 (ok)
```

### Тест 5: Веб-интерфейс

Открыть в браузере: `https://ki.erni-gruppe.ch/`

**Ожидаемый результат**:

- ✅ Страница загружается
- ✅ SSL сертификат валиден (зелёный замок)
- ✅ OpenWebUI интерфейс доступен

---

## КРИТЕРИИ УСПЕХА

После применения решения:

- ✅ DNS запись `ki.erni-gruppe.ch` резолвится в 192.168.62.153
- ✅ Доступ работает с любого компьютера в сети 192.168.62.0/24
- ✅ HTTPS работает с валидным SSL сертификатом
- ✅ OpenWebUI интерфейс загружается корректно
- ✅ Решение задокументировано

---

## КОНТАКТЫ

**IT Отдел ERNI**: [ТРЕБУЕТСЯ УТОЧНИТЬ]

**Ответственный за DNS**: [ТРЕБУЕТСЯ УТОЧНИТЬ]

**Ответственный за ERNI-KI**: [ТРЕБУЕТСЯ УТОЧНИТЬ]

---

**Автор**: Augment Agent  
**Дата**: 2025-10-27  
**Версия**: 1.0
