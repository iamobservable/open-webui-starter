# Настройка внешнего доступа к ERNI-KI системе

**Дата**: 2025-10-27  
**Статус**: ТРЕБУЕТСЯ ДЕЙСТВИЕ  
**Приоритет**: ВЫСОКИЙ

---

## РЕЗЮМЕ ПРОБЛЕМЫ

**Текущее состояние**:

- ✅ Локальный доступ работает: `https://192.168.62.153/` и
  `https://ki.erni-gruppe.ch/` (через /etc/hosts)
- ✅ SSL сертификат валиден: Let's Encrypt E5, CN=ki.erni-gruppe.ch
- ✅ Порты 80/443 открыты на сервере
- ✅ Cloudflare Tunnel работает: `https://webui.diz.zone/` доступен извне
- ❌ Домен `ki.erni-gruppe.ch` НЕ доступен извне

**Корневая причина**:

1. DNS запись `ki.erni-gruppe.ch` существует ТОЛЬКО в `/etc/hosts` на сервере
2. Публичный DNS НЕ содержит запись для `ki.erni-gruppe.ch`
3. Cloudflare Tunnel НЕ настроен для домена `ki.erni-gruppe.ch`
4. Port forwarding НЕ настроен на роутере LANCOM (192.168.62.1)

---

## ДИАГНОСТИКА

### Сетевая конфигурация

| Параметр        | Значение                         |
| --------------- | -------------------------------- |
| Локальный IP    | 192.168.62.153/24                |
| Внешний IP      | 185.242.201.210                  |
| Шлюз            | 192.168.62.1 (LANCOM router)     |
| DNS (локальный) | 192.168.62.153 ki.erni-gruppe.ch |
| DNS (публичный) | НЕТ ЗАПИСИ                       |

### Cloudflare Tunnel

**Статус**: ✅ Работает (Up 3 hours, healthy)

**Настроенные домены**:

- `webui.diz.zone` → http://openwebui:8080 ✅
- `search.diz.zone` → http://searxng:8080 ✅
- `diz.zone` → http://nginx:8080 ✅
- `lite.diz.zone` → http://nginx:8080 ✅

**Отсутствует**:

- ❌ `ki.erni-gruppe.ch` НЕ настроен в Cloudflare Tunnel

### Роутер LANCOM

**Модель**: LANCOM (корпоративный роутер)  
**IP**: 192.168.62.1  
**Веб-интерфейс**: https://192.168.62.1/ (WEBconfig)  
**Доступ**: Требуются учетные данные администратора

**Port Forwarding**: НЕ ПРОВЕРЕН (требуется доступ к роутеру)

---

## РЕШЕНИЯ

### ВАРИАНТ 1: Cloudflare Tunnel (РЕКОМЕНДУЕТСЯ) ✅

**Преимущества**:

- ✅ НЕ требует port forwarding на роутере
- ✅ НЕ требует изменений firewall
- ✅ Встроенная защита от DDoS
- ✅ Автоматический SSL от Cloudflare
- ✅ Работает из любой сети (включая мобильные)
- ✅ Централизованное управление доступом
- ✅ Логирование и аналитика трафика

**Недостатки**:

- ⚠️ Требует настройки DNS в Cloudflare
- ⚠️ Трафик проходит через Cloudflare (может быть проблемой для конфиденциальных
  данных)

**Действия**:

#### 1.1 Добавить домен в Cloudflare Tunnel

**Вариант A: Через Cloudflare Dashboard (рекомендуется)**

1. Войти в Cloudflare Dashboard: https://dash.cloudflare.com/
2. Выбрать аккаунт и перейти в Zero Trust → Access → Tunnels
3. Найти tunnel ID: `02a58963-3f79-4fc0-82ff-f79503366f86`
4. Нажать "Configure" → "Public Hostname" → "Add a public hostname"
5. Заполнить форму:
   - **Subdomain**: `ki`
   - **Domain**: `erni-gruppe.ch`
   - **Service Type**: `HTTP`
   - **URL**: `nginx:8080`
6. Сохранить изменения

**Вариант B: Через конфигурационный файл**

Обновить конфигурацию tunnel в Cloudflare Dashboard, добавив:

```yaml
ingress:
  - hostname: ki.erni-gruppe.ch
    service: http://nginx:8080
  - hostname: webui.diz.zone
    service: http://openwebui:8080
  - hostname: search.diz.zone
    service: http://searxng:8080
  - hostname: diz.zone
    service: http://nginx:8080
  - hostname: lite.diz.zone
    service: http://nginx:8080
  - service: http_status:404
```

#### 1.2 Настроить DNS в Cloudflare

1. Перейти в Cloudflare Dashboard → DNS → Records
2. Добавить CNAME запись:
   - **Type**: CNAME
   - **Name**: `ki`
   - **Target**: `02a58963-3f79-4fc0-82ff-f79503366f86.cfargotunnel.com`
   - **Proxy status**: Proxied (оранжевое облако)
   - **TTL**: Auto

#### 1.3 Проверка

```bash
# Подождать 1-2 минуты для распространения DNS
sleep 120

# Проверить DNS
nslookup ki.erni-gruppe.ch

# Проверить доступ
curl -I https://ki.erni-gruppe.ch/

# Проверить SSL
openssl s_client -connect ki.erni-gruppe.ch:443 -servername ki.erni-gruppe.ch
```

**Ожидаемый результат**:

- DNS резолвится в Cloudflare IP (например, 104.21.x.x или 172.67.x.x)
- HTTP/2 200 OK
- SSL сертификат от Cloudflare

---

### ВАРИАНТ 2: Port Forwarding на роутере LANCOM

**Преимущества**:

- ✅ Прямое подключение (без посредников)
- ✅ Меньшая задержка
- ✅ Полный контроль над трафиком

**Недостатки**:

- ❌ Требует доступа к роутеру LANCOM
- ❌ Требует настройки публичного DNS
- ❌ Требует согласования с IT отделом
- ❌ Нет защиты от DDoS
- ❌ Сложнее в настройке

**Действия**:

#### 2.1 Получить доступ к роутеру LANCOM

**Требуется**:

- Учетные данные администратора роутера
- Согласование с IT отделом ERNI

**Контакты IT отдела**: [ТРЕБУЕТСЯ УТОЧНИТЬ У ПОЛЬЗОВАТЕЛЯ]

#### 2.2 Настроить Port Forwarding

1. Войти в WEBconfig: https://192.168.62.1/
2. Перейти в раздел "Firewall" → "Port Forwarding" (или аналогичный)
3. Добавить правила:

| Внешний порт | Внутренний IP  | Внутренний порт | Протокол | Описание      |
| ------------ | -------------- | --------------- | -------- | ------------- |
| 80           | 192.168.62.153 | 80              | TCP      | ERNI-KI HTTP  |
| 443          | 192.168.62.153 | 443             | TCP      | ERNI-KI HTTPS |

4. Сохранить и применить изменения

#### 2.3 Настроить публичный DNS

**Вариант A: Через регистратора домена erni-gruppe.ch**

1. Войти в панель управления регистратора
2. Добавить A запись:
   - **Name**: `ki`
   - **Type**: A
   - **Value**: `185.242.201.210`
   - **TTL**: 3600

**Вариант B: Через Cloudflare (без Tunnel)**

1. Добавить домен `erni-gruppe.ch` в Cloudflare
2. Обновить NS записи у регистратора
3. Добавить A запись в Cloudflare:
   - **Name**: `ki`
   - **Type**: A
   - **Value**: `185.242.201.210`
   - **Proxy status**: DNS only (серое облако)

#### 2.4 Проверка

```bash
# Подождать 5-10 минут для распространения DNS
sleep 600

# Проверить DNS
nslookup ki.erni-gruppe.ch

# Проверить доступ извне
curl -I https://ki.erni-gruppe.ch/

# Проверить порты
nc -zv 185.242.201.210 80
nc -zv 185.242.201.210 443
```

---

### ВАРИАНТ 3: Гибридное решение (Cloudflare + Port Forwarding)

**Описание**: Использовать Cloudflare как прокси перед прямым подключением

**Преимущества**:

- ✅ Защита от DDoS от Cloudflare
- ✅ SSL от Cloudflare
- ✅ Кэширование статики
- ✅ Аналитика трафика

**Недостатки**:

- ⚠️ Требует настройки и port forwarding, и Cloudflare
- ⚠️ Более сложная конфигурация

**Действия**: Комбинация Вариант 1 (шаг 1.2) + Вариант 2 (шаги 2.1-2.2)

---

## РЕКОМЕНДАЦИЯ

**Для корпоративной среды ERNI рекомендуется ВАРИАНТ 1 (Cloudflare Tunnel)**

**Обоснование**:

1. ✅ Cloudflare Tunnel уже настроен и работает для других доменов
2. ✅ НЕ требует согласования с IT отделом (нет изменений в сетевой
   инфраструктуре)
3. ✅ Встроенная безопасность и защита от DDoS
4. ✅ Простота настройки (5-10 минут)
5. ✅ Централизованное управление всеми доменами ERNI-KI

**Время реализации**: 10-15 минут  
**Требуемые права**: Доступ к Cloudflare Dashboard

---

## ИНСТРУКЦИЯ ДЛЯ IT ОТДЕЛА

Если выбран **Вариант 2 (Port Forwarding)**, предоставьте IT отделу следующую
информацию:

### Требуемые настройки роутера LANCOM (192.168.62.1)

**Port Forwarding Rules**:

```
External IP: 185.242.201.210
Internal IP: 192.168.62.153

Rule 1:
  Name: ERNI-KI-HTTP
  External Port: 80
  Internal IP: 192.168.62.153
  Internal Port: 80
  Protocol: TCP
  Enabled: Yes

Rule 2:
  Name: ERNI-KI-HTTPS
  External Port: 443
  Internal IP: 192.168.62.153
  Internal Port: 443
  Protocol: TCP
  Enabled: Yes
```

**Firewall Rules** (если требуется):

- Разрешить входящие подключения на порты 80/443 для IP 192.168.62.153

**DNS настройки** (если управляется IT отделом):

- Добавить A запись: `ki.erni-gruppe.ch` → `185.242.201.210`

---

## ТЕКУЩИЙ СТАТУС

| Компонент             | Статус         | Комментарий             |
| --------------------- | -------------- | ----------------------- |
| Локальный доступ      | ✅ Работает    | https://192.168.62.153/ |
| SSL сертификат        | ✅ Валиден     | Let's Encrypt E5        |
| Nginx                 | ✅ Работает    | Порты 80/443 открыты    |
| Cloudflare Tunnel     | ✅ Работает    | webui.diz.zone доступен |
| DNS ki.erni-gruppe.ch | ❌ Не настроен | Только /etc/hosts       |
| Port Forwarding       | ❓ Неизвестно  | Требуется проверка      |
| Внешний доступ        | ❌ Не работает | Требуется настройка     |

---

## СЛЕДУЮЩИЕ ШАГИ

1. **Выбрать вариант решения** (рекомендуется Вариант 1)
2. **Получить доступ к Cloudflare Dashboard** (для Варианта 1)
   - ИЛИ -
3. **Связаться с IT отделом** (для Варианта 2)
4. **Применить настройки** согласно выбранному варианту
5. **Протестировать доступ** с внешнего компьютера
6. **Обновить документацию** с результатами

---

**Автор**: Augment Agent  
**Дата**: 2025-10-27  
**Версия**: 1.0
