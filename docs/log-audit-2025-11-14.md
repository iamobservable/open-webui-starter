# ERNI-KI Log Audit – 2025-11-14

## Область и методика

- Репозиторий: `erni-ki`, каталог
  `/home/konstantin/Documents/augment-projects/erni-ki`
- Источники: `logs/`, `.config-backup/logs/`,
  `.config-backup/monitoring/cron.log`, `scripts/infrastructure/logs/`
- Подход: ручной просмотр свежих логов, фиксация временных меток, классификация
  по серьёзности и оценка влияния/рекомендаций.

## Ключевые находки

### Critical

1. **Docling shared volume не обслуживается**
   (`logs/docling-shared-cleanup.log:1`)
   - Cron-скрипт не может создать каталог `data/docling/shared/uploads` из-за
     прав. Обработка файлов и очистка PII не выполняются.
   - _Что делать_: выдать права пользователю, под которым работает cron
     (`chown -R docling:docling data/docling`) и перезапустить задачу.

2. **Внешний HTTPS недоступен** (`logs/ssl-monitor.log:1-2`)
   - Мониторинг дважды подтвердил, что `ki.erni-gruppe.ch` не отвечает. Это
     ломает внешние интеграции/SSO.
   - _Что делать_: проверить DNS/Ingress, убедиться, что сертификат и прокси
     активны, и поднять HealthCheck в Alertmanager как critical.

3. **Redis испытывает хроническую фрагментацию**
   (`logs/redis-fragmentation-watchdog.log`)
   - С 09:35–17:50 CET коэффициент 5.6–5.9 при пороге 4.0, watchdog каждые 5
     минут пускает `memory purge`, но показатели не падают.
   - _Что делать_: увеличить `maxmemory` и пересоздать instance с
     `activedefrag yes` + убедиться, что рабочая нагрузка не переполняет
     ключи/TTL.

4. **Alertmanager queue растёт экспоненциально**
   (`.config-backup/logs/alertmanager-queue.log`)
   - С 11:05 13 ноября очередь превышает порог 100 и к 08:05 14 ноября достигла
     1 218 событий. Уведомления могут теряться.
   - _Что делать_: проверить webhook/SMTP приёмники, уменьшить fan-out, добавить
     шардирование Alertmanager или увеличить ресурс очереди.

5. **Потеря критических логов и 17 764 критических записей/30 мин**
   (`.config-backup/monitoring/cron.log`)
   - Health Monitor фиксирует `CriticalServiceLogsMissing` и подсчитывает
     десятки тысяч критов. Логи либо не ротуются, либо Fluent Bit переполнен.
   - _Что делать_: валидировать пути logrotate, проверить Fluent Bit storage
     (`/var/lib/fluent-bit/`), добавить фильтры шумных источников.

### High

6. **Docker Compose ps недоступен** (`.config-backup/monitoring/cron.log`)
   - Каждая проверка контейнеров падает: вероятно, cron запускается без
     переменной `DOCKER_HOST` или без прав на сокет.
   - _Что делать_: добавить пользователя в `docker` group и экспортировать
     `COMPOSE_PROFILES`/`DOCKER_HOST` в cron.env.

7. **Nginx proxy health-check возвращает не тот ответ**
   (`.config-backup/monitoring/cron.log`)
   - Проверка ожидает `ok`, но получает иной content. Может быть SPA redirect
     или 502.
   - _Что делать_: добавить `/healthz` endpoint на прокси и обновить скрипт
     мониторинга.

8. **Множественные предупреждения Alertmanager**
   (`.config-backup/logs/alerts.log`)
   - Активны `AlertmanagerClusterHealthLow`, `FluentBitHighMemoryUsage`,
     `HTTPErrors`, `HighHTTPResponseTime`, `RedisHTTPErrors`.
   - _Что делать_: пересобрать Alertmanager, проверить Fluent Bit limits и
     устранить сетевые проблемы blackbox-exporter.

### Medium

9. **Rate-limiting монитор не видит nginx-логи**
   (`scripts/infrastructure/logs/rate-limiting-monitor.log`)
   - Каждую минуту отчёт «Нет логов nginx». Значит, либо путь в
     `NGINX_ACCESS_LOG` неверный, либо Vector/Fluent Bit перехватывает логи
     прежде.
   - _Что делать_: перепривязать `tail -F` к фактическому файлу
     (`/var/log/nginx/access.log`) или смонтировать volume в контейнер
     мониторинга.

10. **SSL/watchtower ротация не чистит Fluent Bit DB** (`logs/rotation.log`)
    - Скрипт сообщает пустое значение для `Fluent Bit DB` размера, значит сбор
      статистики не читает каталог.
    - _Что делать_: скорректировать `du -sh "$FLUENTBIT_DB"` и добавить алерт
      при превышении порога.

## Рекомендации по следующему шагу

1. Разблокировать Docling volume и повторно прогнать
   `scripts/infrastructure/docling-shared-cleanup.sh`, чтобы убрать PII.
2. Провести постморем Alertmanager/Redis: снять метрики, уменьшить шум
   (HTTPErrors) и добавить автоскейл.
3. Восстановить Nginx/HTTPS и docker-compose health в cron, затем обновить
   `alerts.log`, чтобы critical алерты ушли.
4. Добавить автоматизированный отчёт (через Archon docs) раз в неделю, чтобы
   фиксировать тренды очереди и фрагментации.

## Выполненные исправления — 2025-11-14

- `scripts/maintenance/docling-shared-cleanup.sh` теперь умеет создавать
  каталоги с нужными правами/владельцами и, при необходимости, использует
  `sudo`, что устраняет Permission denied в cron.
- `scripts/infrastructure/security/monitor-certificates.sh` автоматически
  пытается перезапустить Nginx при падении HTTPS (локально или по домену) и
  проверяет `/health`.
- `scripts/maintenance/redis-fragmentation-watchdog.sh` следит за повторяющимися
  purge, включает activedefrag при каждом запуске и рестартует Redis после
  `MAX_PURGES`, чтобы не спамить лог.
- `scripts/monitoring/alertmanager-queue-watch.sh` получает жёсткий лимит и
  перезапускает Alertmanager при превышении, фиксируя событие в журнале.
- `scripts/infrastructure/monitoring/monitor-rate-limiting.sh` теперь читает
  реальные access-логи (если Docker не отдаёт свежие записи) и использует
  `docker compose`, чтобы монитор снова видел события.
- `scripts/infrastructure/security/rotate-logs.sh` корректно отображает размер
  Fluent Bit DB и не печатает пустые значения.
